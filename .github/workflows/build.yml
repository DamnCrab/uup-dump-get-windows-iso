# GitHub Actions Workflow for Windows ISO Build
# Windows ISO æž„å»ºçš„ GitHub Actions å·¥ä½œæµ
#
# This workflow automatically builds Windows ISO files using UUP Dump
# è¯¥å·¥ä½œæµä½¿ç”¨ UUP Dump è‡ªåŠ¨æž„å»º Windows ISO æ–‡ä»¶

name: build

# Trigger conditions / è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:  # Manual trigger / æ‰‹åŠ¨è§¦å‘
  schedule:
    #- cron: '0 * * * *' # hourly / æ¯å°æ—¶
    #- cron: '0 0 17 * *' # every month, the 17th day / æ¯æœˆ17æ—¥
    - cron: '0 2 * * *' # daily at 2 AM UTC / æ¯æ—¥UTCæ—¶é—´2ç‚¹

jobs:
  # Main build job / ä¸»æž„å»ºä»»åŠ¡
  build:
    continue-on-error: true  # Continue even if one matrix job fails / å³ä½¿æŸä¸ªçŸ©é˜µä»»åŠ¡å¤±è´¥ä¹Ÿç»§ç»­
    strategy:
      fail-fast: false      # Don't cancel other jobs on failure / å¤±è´¥æ—¶ä¸å–æ¶ˆå…¶ä»–ä»»åŠ¡
      matrix:

        include:
          # Windows 11 24H2 targets / Windows 11 24H2 ç›®æ ‡
          - name: windows-11-24h2-zh-cn-pro        # Windows 11 24H2 ä¸­æ–‡ç®€ä½“ä¸“ä¸šç‰ˆ
          - name: windows-11-24h2-zh-cn-home       # Windows 11 24H2 ä¸­æ–‡ç®€ä½“å®¶åº­ç‰ˆ
          - name: windows-11-24h2-zh-cn-multi      # Windows 11 24H2 ä¸­æ–‡ç®€ä½“å¤šç‰ˆæœ¬
          - name: windows-11-24h2-en-us-pro        # Windows 11 24H2 English US Professional
          - name: windows-11-24h2-en-us-home       # Windows 11 24H2 English US Home
          
          # Windows 11 Insider Preview targets / Windows 11 Insider Preview ç›®æ ‡
          - name: windows-11-insider-zh-cn         # Windows 11 Insider Preview ä¸­æ–‡ç®€ä½“
          - name: windows-11-insider-en-us         # Windows 11 Insider Preview English US
          
          # ARM64 targets / ARM64 ç›®æ ‡
          - name: windows-11-24h2-zh-cn-arm64      # Windows 11 24H2 ä¸­æ–‡ç®€ä½“ ARM64
          
          # Enterprise and Education editions / ä¼ä¸šç‰ˆå’Œæ•™è‚²ç‰ˆ
          - name: windows-11-24h2-zh-cn-enterprise # Windows 11 24H2 ä¸­æ–‡ç®€ä½“ä¼ä¸šç‰ˆ
          - name: windows-11-24h2-zh-cn-education  # Windows 11 24H2 ä¸­æ–‡ç®€ä½“æ•™è‚²ç‰ˆ
    runs-on: windows-2025  # Use Windows 2025 runner / ä½¿ç”¨ Windows 2025 è¿è¡Œå™¨
    steps:
      # Random delay to prevent concurrency issues / æ·»åŠ éšæœºå»¶æ—¶ä»¥é˜²æ­¢å¹¶å‘é—®é¢˜
      - name: Random delay
        shell: pwsh
        run: Start-Sleep -Seconds (Get-Random -Minimum 1 -Maximum 60)
      # Checkout source code / æ£€å‡ºæºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # Install pnpm package manager / å®‰è£… pnpm åŒ…ç®¡ç†å™¨
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # Setup Node.js environment / è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'  # Use Node.js 24 / ä½¿ç”¨ Node.js 24
          cache: 'pnpm'       # Cache pnpm dependencies / ç¼“å­˜ pnpm ä¾èµ–
      
      # Install project dependencies / å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: pnpm install
      
      # Build Windows ISO for the specified target / ä¸ºæŒ‡å®šç›®æ ‡æž„å»º Windows ISO
      - name: Build ISO
        shell: pwsh
        run: |
          $pwshPath = Get-Command pwsh | Select-Object -ExpandProperty Source
          $pwshDir = Split-Path $pwshPath -Parent
          $env:Path = "$pwshDir;" + $env:Path
          pnpm start --target ${{ matrix.name }}
      
      # Upload build artifacts / ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            output/**/*.iso
            output/**/uup_monitor.log
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Generate release notes
        run: |
          cat > release-notes.md <<EOF
          # ðŸ–¥ï¸ Windows ISO Build - Run #${{ github.run_number }}

          **Build Date**: $(date -u +"%Y-%m-%d %H:%M UTC")
          **Workflow Run**: [Link to run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## ðŸ“¥ Artifacts

          Click the links below to download the build artifacts. You must be logged into GitHub to download.

          | Build Target | Artifact Link |
          |--------------|---------------|
          | [windows-11-24h2-zh-cn-pro](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-pro) | Professional (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-home](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-home) | Home (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-multi](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-multi) | Multi-Edition (Simplified Chinese) |
          | [windows-11-24h2-en-us-pro](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-en-us-pro) | Professional (US English) |
          | [windows-11-24h2-en-us-home](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-en-us-home) | Home (US English) |
          | [windows-11-insider-zh-cn](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-insider-zh-cn) | Insider Preview (Simplified Chinese) |
          | [windows-11-insider-en-us](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-insider-en-us) | Insider Preview (US English) |
          | [windows-11-24h2-zh-cn-arm64](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-arm64) | ARM64 (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-enterprise](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-enterprise) | Enterprise (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-education](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-education) | Education (Simplified Chinese) |
          EOF

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          bodyFile: "release-notes.md"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "build-${{ github.run_number }}"
          name: "Build #${{ github.run_number }}"
