# Auto build Windows ISO using UUP Dump
# ä½¿ç”¨ UUP Dump è‡ªåŠ¨æž„å»º Windows ISO
name: build

on:
  workflow_dispatch: # Manual trigger / æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * 0,3' # Run at 00:00 on Sunday and Wednesday / æ¯å‘¨æ—¥å’Œå‘¨ä¸‰çš„00:00è¿è¡Œ

jobs:
  # Cleanup old artifacts / æ¸…ç†æ—§çš„æž„å»ºäº§ç‰©
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Purge old artifacts
        uses: kolpav/purge-artifacts-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          expire-in: 30d # Delete artifacts older than 30 days / åˆ é™¤30å¤©å‰çš„æž„å»ºäº§ç‰©

  # Main build job / ä¸»æž„å»ºä»»åŠ¡
  build:
    needs: cleanup
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          # Targets / æž„å»ºç›®æ ‡
          - name: windows-11-24h2-zh-cn-pro
          - name: windows-11-24h2-zh-cn-home
          - name: windows-11-24h2-zh-cn-multi
          - name: windows-11-24h2-en-us-pro
          - name: windows-11-24h2-en-us-home
          - name: windows-11-insider-zh-cn
          - name: windows-11-insider-en-us
          - name: windows-11-24h2-zh-cn-arm64
          - name: windows-11-24h2-zh-cn-enterprise
          - name: windows-11-24h2-zh-cn-education

    runs-on: windows-2025
    steps:
      # Random delay / éšæœºå»¶æ—¶
      - name: Random delay
        shell: pwsh
        run: Start-Sleep -Seconds (Get-Random -Minimum 1 -Maximum 60)

      # Checkout code / æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # Install pnpm / å®‰è£… pnpm
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # Setup Node.js / è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      # Install dependencies / å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install

      # Build ISO / æž„å»º ISO
      - name: Build ISO
        shell: pwsh
        run: |
          $pwshPath = Get-Command pwsh | Select-Object -ExpandProperty Source
          $pwshDir = Split-Path $pwshPath -Parent
          $env:Path = "$pwshDir;" + $env:Path
          pnpm start --target ${{ matrix.name }}

      # Upload artifacts / ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            output/**/*.iso
            output/**/uup_monitor.log
          retention-days: 30 # Keep artifacts for 30 days / æž„å»ºäº§ç‰©ä¿ç•™30å¤©

  # Create release / åˆ›å»ºå‘å¸ƒ
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      # Generate release notes / ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      - name: Generate release notes
        run: |
          cat > release-notes.md <<EOF
          # ðŸ–¥ï¸ Windows ISO Build - Run #${{ github.run_number }}

          **Build Date**: $(date -u +"%Y-%m-%d %H:%M UTC")
          **Workflow Run**: [Link to run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## ðŸ“¥ Artifacts

          Click the links below to download the build artifacts. You must be logged into GitHub to download.

          | Build Target | Artifact Link |
          |--------------|---------------|
          | [windows-11-24h2-zh-cn-pro](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-pro) | Professional (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-home](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-home) | Home (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-multi](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-multi) | Multi-Edition (Simplified Chinese) |
          | [windows-11-24h2-en-us-pro](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-en-us-pro) | Professional (US English) |
          | [windows-11-24h2-en-us-home](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-en-us-home) | Home (US English) |
          | [windows-11-insider-zh-cn](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-insider-zh-cn) | Insider Preview (Simplified Chinese) |
          | [windows-11-insider-en-us](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-insider-en-us) | Insider Preview (US English) |
          | [windows-11-24h2-zh-cn-arm64](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-arm64) | ARM64 (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-enterprise](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-enterprise) | Enterprise (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-education](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-education) | Education (Simplified Chinese) |
          EOF

      # Create Release / åˆ›å»ºå‘å¸ƒ
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          bodyFile: "release-notes.md"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "build-${{ github.run_number }}"
          name: "Build #${{ github.run_number }}"
