# GitHub Actions Workflow for Windows ISO Build
# Windows ISO 构建的 GitHub Actions 工作流
#
# This workflow automatically builds Windows ISO files using UUP Dump
# 该工作流使用 UUP Dump 自动构建 Windows ISO 文件

name: build

# Trigger conditions / 触发条件
on:
  workflow_dispatch:  # Manual trigger / 手动触发
  schedule:
    #- cron: '0 * * * *' # hourly / 每小时
    #- cron: '0 0 17 * *' # every month, the 17th day / 每月17日
    - cron: '0 2 * * *' # daily at 2 AM UTC / 每日UTC时间2点

jobs:
  # Main build job / 主构建任务
  build:
    continue-on-error: true  # Continue even if one matrix job fails / 即使某个矩阵任务失败也继续
    strategy:
      fail-fast: false      # Don't cancel other jobs on failure / 失败时不取消其他任务
      matrix:

        include:
          # Windows 11 24H2 targets / Windows 11 24H2 目标
          - name: windows-11-24h2-zh-cn-pro        # Windows 11 24H2 中文简体专业版
          - name: windows-11-24h2-zh-cn-home       # Windows 11 24H2 中文简体家庭版
          - name: windows-11-24h2-zh-cn-multi      # Windows 11 24H2 中文简体多版本
          - name: windows-11-24h2-en-us-pro        # Windows 11 24H2 English US Professional
          - name: windows-11-24h2-en-us-home       # Windows 11 24H2 English US Home
          
          # Windows 11 Insider Preview targets / Windows 11 Insider Preview 目标
          - name: windows-11-insider-zh-cn         # Windows 11 Insider Preview 中文简体
          - name: windows-11-insider-en-us         # Windows 11 Insider Preview English US
          
          # ARM64 targets / ARM64 目标
          - name: windows-11-24h2-zh-cn-arm64      # Windows 11 24H2 中文简体 ARM64
          
          # Enterprise and Education editions / 企业版和教育版
          - name: windows-11-24h2-zh-cn-enterprise # Windows 11 24H2 中文简体企业版
          - name: windows-11-24h2-zh-cn-education  # Windows 11 24H2 中文简体教育版
    runs-on: windows-2025  # Use Windows 2025 runner / 使用 Windows 2025 运行器
    steps:
      # Random delay to prevent concurrency issues / 添加随机延时以防止并发问题
      - name: Random delay
        shell: pwsh
        run: Start-Sleep -Seconds (Get-Random -Minimum 1 -Maximum 60)
      # Checkout source code / 检出源代码
      - name: Checkout
        uses: actions/checkout@v4

      # Install pnpm package manager / 安装 pnpm 包管理器
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # Setup Node.js environment / 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'  # Use Node.js 24 / 使用 Node.js 24
          cache: 'pnpm'       # Cache pnpm dependencies / 缓存 pnpm 依赖
      
      # Install project dependencies / 安装项目依赖
      - name: Install dependencies
        run: pnpm install
      
      # Build Windows ISO for the specified target / 为指定目标构建 Windows ISO
      - name: Build ISO
        shell: pwsh
        run: |
          $pwshPath = Get-Command pwsh | Select-Object -ExpandProperty Source
          $pwshDir = Split-Path $pwshPath -Parent
          $env:Path = "$pwshDir;" + $env:Path
          pnpm start --target ${{ matrix.name }}
      
      # Upload build artifacts / 上传构建产物
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            output/**/*.iso
            output/**/uup_monitor.log
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Generate release notes
        run: |
          cat > release-notes.md <<EOF
          # 🖥️ Windows ISO Build - Run #${{ github.run_number }}

          **Build Date**: $(date -u +"%Y-%m-%d %H:%M UTC")
          **Workflow Run**: [Link to run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## 📥 Artifacts

          Click the links below to download the build artifacts. You must be logged into GitHub to download.

          | Build Target | Artifact Link |
          |--------------|---------------|
          | [windows-11-24h2-zh-cn-pro](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-pro) | Professional (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-home](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-home) | Home (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-multi](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-multi) | Multi-Edition (Simplified Chinese) |
          | [windows-11-24h2-en-us-pro](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-en-us-pro) | Professional (US English) |
          | [windows-11-24h2-en-us-home](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-en-us-home) | Home (US English) |
          | [windows-11-insider-zh-cn](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-insider-zh-cn) | Insider Preview (Simplified Chinese) |
          | [windows-11-insider-en-us](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-insider-en-us) | Insider Preview (US English) |
          | [windows-11-24h2-zh-cn-arm64](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-arm64) | ARM64 (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-enterprise](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-enterprise) | Enterprise (Simplified Chinese) |
          | [windows-11-24h2-zh-cn-education](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/windows-11-24h2-zh-cn-education) | Education (Simplified Chinese) |
          EOF

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          bodyFile: "release-notes.md"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "build-${{ github.run_number }}"
          name: "Build #${{ github.run_number }}"
