# GitHub Actions Workflow for Windows ISO Build
# Windows ISO æž„å»ºçš„ GitHub Actions å·¥ä½œæµ
#
# This workflow automatically builds Windows ISO files using UUP Dump
# è¯¥å·¥ä½œæµä½¿ç”¨ UUP Dump è‡ªåŠ¨æž„å»º Windows ISO æ–‡ä»¶

name: build

# Trigger conditions / è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:  # Manual trigger / æ‰‹åŠ¨è§¦å‘
  schedule:
    #- cron: '0 * * * *' # hourly / æ¯å°æ—¶
    #- cron: '0 0 17 * *' # every month, the 17th day / æ¯æœˆ17æ—¥
    - cron: '0 2 * * *' # daily at 2 AM UTC / æ¯æ—¥UTCæ—¶é—´2ç‚¹

jobs:
  # Main build job / ä¸»æž„å»ºä»»åŠ¡
  build:
    continue-on-error: true  # Continue even if one matrix job fails / å³ä½¿æŸä¸ªçŸ©é˜µä»»åŠ¡å¤±è´¥ä¹Ÿç»§ç»­
    strategy:
      fail-fast: false      # Don't cancel other jobs on failure / å¤±è´¥æ—¶ä¸å–æ¶ˆå…¶ä»–ä»»åŠ¡
      matrix:
        # Matrix configuration corresponds to TARGETS keys in src/config/targets.ts
    # Matrix é…ç½®å¯¹åº” src/config/targets.ts ä¸­çš„ TARGETS é”®
    # Use 'pnpm start --list' to see all available target configurations
    # ä½¿ç”¨ 'pnpm start --list' æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„ç›®æ ‡é…ç½®
    # Use 'pnpm generate-matrix' to auto-generate this matrix configuration
    # ä½¿ç”¨ 'pnpm generate-matrix' è‡ªåŠ¨ç”Ÿæˆæ­¤ matrix é…ç½®
        include:
          # Windows 11 24H2 targets / Windows 11 24H2 ç›®æ ‡
          - name: windows-11-24h2-zh-cn-pro        # Windows 11 24H2 ä¸­æ–‡ç®€ä½“ä¸“ä¸šç‰ˆ
          - name: windows-11-24h2-zh-cn-home       # Windows 11 24H2 ä¸­æ–‡ç®€ä½“å®¶åº­ç‰ˆ
          - name: windows-11-24h2-zh-cn-multi      # Windows 11 24H2 ä¸­æ–‡ç®€ä½“å¤šç‰ˆæœ¬
          - name: windows-11-24h2-en-us-pro        # Windows 11 24H2 English US Professional
          - name: windows-11-24h2-en-us-home       # Windows 11 24H2 English US Home
          
          # Windows 11 Insider Preview targets / Windows 11 Insider Preview ç›®æ ‡
          - name: windows-11-insider-zh-cn         # Windows 11 Insider Preview ä¸­æ–‡ç®€ä½“
          - name: windows-11-insider-en-us         # Windows 11 Insider Preview English US
          
          # ARM64 targets / ARM64 ç›®æ ‡
          - name: windows-11-24h2-zh-cn-arm64      # Windows 11 24H2 ä¸­æ–‡ç®€ä½“ ARM64
          
          # Enterprise and Education editions / ä¼ä¸šç‰ˆå’Œæ•™è‚²ç‰ˆ
          - name: windows-11-24h2-zh-cn-enterprise # Windows 11 24H2 ä¸­æ–‡ç®€ä½“ä¼ä¸šç‰ˆ
          - name: windows-11-24h2-zh-cn-education  # Windows 11 24H2 ä¸­æ–‡ç®€ä½“æ•™è‚²ç‰ˆ
    runs-on: windows-2022  # Use Windows 2022 runner / ä½¿ç”¨ Windows 2022 è¿è¡Œå™¨
    steps:
      # Checkout source code / æ£€å‡ºæºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # Install pnpm package manager / å®‰è£… pnpm åŒ…ç®¡ç†å™¨
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # Setup Node.js environment / è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'  # Use Node.js 24 / ä½¿ç”¨ Node.js 24
          cache: 'pnpm'       # Cache pnpm dependencies / ç¼“å­˜ pnpm ä¾èµ–
      
      # Install project dependencies / å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: pnpm install
      
      # Build Windows ISO for the specified target / ä¸ºæŒ‡å®šç›®æ ‡æž„å»º Windows ISO
      - name: Build ISO
        run: pnpm start --target ${{ matrix.name }}
      
      # Upload build artifacts / ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}  # Artifact name matches matrix name / äº§ç‰©åç§°åŒ¹é…çŸ©é˜µåç§°
          path: output/             # Upload output directory / ä¸Šä¼ è¾“å‡ºç›®å½•
          retention-days: 1         # Keep artifacts for 1 day / ä¿ç•™äº§ç‰©1å¤©
  # Release job / å‘å¸ƒä»»åŠ¡
  # Note: This job will not produce a useful release for large ISO files
  # æ³¨æ„ï¼šæ­¤ä»»åŠ¡ä¸ä¼šä¸ºå¤§åž‹ ISO æ–‡ä»¶äº§ç”Ÿæœ‰ç”¨çš„å‘å¸ƒ
  # because GitHub releases have a 2GB file size limit and these ISO files are usually above 4GB
  # å› ä¸º GitHub å‘å¸ƒæœ‰ 2GB æ–‡ä»¶å¤§å°é™åˆ¶ï¼Œè€Œè¿™äº› ISO æ–‡ä»¶é€šå¸¸è¶…è¿‡ 4GB
  release:
    needs: build                    # Depends on build job completion / ä¾èµ–æž„å»ºä»»åŠ¡å®Œæˆ
    runs-on: ubuntu-latest         # Use Ubuntu runner / ä½¿ç”¨ Ubuntu è¿è¡Œå™¨
    if: github.ref == 'refs/heads/main'  # Only run on main branch / ä»…åœ¨ä¸»åˆ†æ”¯è¿è¡Œ
    steps:
      # Checkout source code / æ£€å‡ºæºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
      # Download all build artifacts / ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: output  # Download to output directory / ä¸‹è½½åˆ°è¾“å‡ºç›®å½•
      
      # Split large ISO files into volumes for GitHub release / å°†å¤§åž‹ ISO æ–‡ä»¶åˆ†å·ä»¥é€‚åº” GitHub å‘å¸ƒ
      - name: Split large files into volumes
        run: |
          # Install 7z if not available / å¦‚æžœä¸å¯ç”¨åˆ™å®‰è£… 7z
          sudo apt-get update && sudo apt-get install -y p7zip-full
          
          # Check available disk space / æ£€æŸ¥å¯ç”¨ç£ç›˜ç©ºé—´
          echo "Available disk space:"
          df -h
          
          # Create compressed directory for split files / ä¸ºåˆ†å·æ–‡ä»¶åˆ›å»ºåŽ‹ç¼©ç›®å½•
          mkdir -p compressed
          
          # Process each artifact directory independently / ç‹¬ç«‹å¤„ç†æ¯ä¸ªäº§ç‰©ç›®å½•
          for dir in output/*/; do
            if [ -d "$dir" ]; then
              artifact_name=$(basename "$dir")
              echo "Processing artifact: $artifact_name"
              
              # Create subdirectory for this artifact's compressed files / ä¸ºæ­¤äº§ç‰©çš„åŽ‹ç¼©æ–‡ä»¶åˆ›å»ºå­ç›®å½•
              mkdir -p "compressed/$artifact_name"
              
              # Check if ISO file exists and its size / æ£€æŸ¥ ISO æ–‡ä»¶æ˜¯å¦å­˜åœ¨åŠå…¶å¤§å°
              iso_file=$(find "$dir" -name "*.iso" | head -1)
              if [ -f "$iso_file" ]; then
                iso_size=$(stat -c%s "$iso_file")
                echo "ISO file size: $iso_size bytes"
                
                # Check available space before compression / åŽ‹ç¼©å‰æ£€æŸ¥å¯ç”¨ç©ºé—´
                available_space=$(df --output=avail . | tail -1)
                echo "Available space: $available_space KB"
                
                # If ISO is larger than 1.8GB (leaving some margin), split it / å¦‚æžœ ISO å¤§äºŽ 1.8GBï¼ˆç•™ä¸€äº›ä½™é‡ï¼‰ï¼Œåˆ™åˆ†å·
                if [ $iso_size -gt 1932735283 ]; then
                  echo "ISO file is large, creating split archive..."
                  # Use lower compression level and smaller volumes for better reliability / ä½¿ç”¨è¾ƒä½ŽåŽ‹ç¼©çº§åˆ«å’Œè¾ƒå°åˆ†å·ä»¥æé«˜å¯é æ€§
                  # -mx=1 for fastest compression, -v1800m for 1.8GB volumes / -mx=1 æœ€å¿«åŽ‹ç¼©ï¼Œ-v1800m 1.8GB åˆ†å·
                  if ! 7z a -t7z -mx=1 -v1800m "compressed/$artifact_name/${artifact_name}.7z" "$dir"*; then
                    echo "Error: Failed to create split archive for $artifact_name"
                    echo "Trying with even smaller volumes (1GB)..."
                    rm -f "compressed/$artifact_name/${artifact_name}.7z"*
                    if ! 7z a -t7z -mx=1 -v1000m "compressed/$artifact_name/${artifact_name}.7z" "$dir"*; then
                      echo "Error: Failed to create archive even with 1GB volumes"
                      # As fallback, just copy the files without compression / ä½œä¸ºåŽå¤‡ï¼Œç›´æŽ¥å¤åˆ¶æ–‡ä»¶ä¸åŽ‹ç¼©
                      echo "Fallback: Copying files without compression"
                      cp "$dir"* "compressed/$artifact_name/"
                    else
                      echo "Created split archive with 1GB volumes for $artifact_name"
                    fi
                  else
                    echo "Created split archive for $artifact_name"
                  fi
                else
                  echo "ISO file is small enough, creating single archive..."
                  # Create single 7z archive in artifact subdirectory with low compression / åœ¨äº§ç‰©å­ç›®å½•ä¸­åˆ›å»ºå•ä¸ªä½ŽåŽ‹ç¼© 7z æ¡£æ¡ˆ
                  if ! 7z a -t7z -mx=1 "compressed/$artifact_name/${artifact_name}.7z" "$dir"*; then
                    echo "Error: Failed to create single archive for $artifact_name"
                    echo "Fallback: Copying files without compression"
                    cp "$dir"* "compressed/$artifact_name/"
                  else
                    echo "Created single archive for $artifact_name"
                  fi
                fi
              else
                echo "No ISO file found in $artifact_name, creating single archive..."
                # Create single 7z archive for non-ISO artifacts in artifact subdirectory / ä¸ºéž ISO äº§ç‰©åœ¨äº§ç‰©å­ç›®å½•ä¸­åˆ›å»ºå•ä¸ª 7z æ¡£æ¡ˆ
                if ! 7z a -t7z -mx=1 "compressed/$artifact_name/${artifact_name}.7z" "$dir"*; then
                  echo "Error: Failed to create archive for $artifact_name"
                  echo "Fallback: Copying files without compression"
                  cp "$dir"* "compressed/$artifact_name/"
                else
                  echo "Created archive for $artifact_name"
                fi
              fi
              
              # Clean up to save space after each artifact / å¤„ç†æ¯ä¸ªäº§ç‰©åŽæ¸…ç†ä»¥èŠ‚çœç©ºé—´
              echo "Cleaning up original files for $artifact_name to save space"
              rm -rf "$dir"
              
              # Check disk space after processing each artifact / å¤„ç†æ¯ä¸ªäº§ç‰©åŽæ£€æŸ¥ç£ç›˜ç©ºé—´
              echo "Disk space after processing $artifact_name:"
              df -h
            fi
          done
          
          # List all created compressed files organized by artifact / åˆ—å‡ºæŒ‰äº§ç‰©ç»„ç»‡çš„æ‰€æœ‰å·²åˆ›å»ºåŽ‹ç¼©æ–‡ä»¶
          echo "Created compressed files:"
          find compressed/ -type f | sort
      # Generate release notes with artifact links / ç”ŸæˆåŒ…å«äº§ç‰©é“¾æŽ¥çš„å‘å¸ƒè¯´æ˜Ž
      - name: Generate release notes with artifact links
        run: |
          # Get build timestamp / èŽ·å–æž„å»ºæ—¶é—´æˆ³
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          # Create release notes header / åˆ›å»ºå‘å¸ƒè¯´æ˜Žå¤´éƒ¨
          cat >release-notes.md <<EOF
          # ðŸ–¥ï¸ Windows ä¸­æ–‡ç‰ˆ ISO æž„å»º
          
          **æž„å»ºæ—¶é—´**: $BUILD_DATE  
          **æž„å»ºç¼–å·**: #${{ github.run_number }}  
          **æž„å»ºè¯¦æƒ…**: [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ## ðŸ“‹ æž„å»ºå†…å®¹
          
          | ç³»ç»Ÿç‰ˆæœ¬ | æž„å»ºå· | æ–‡ä»¶ç±»åž‹ | æ ¡éªŒç  |
          |---------|--------|----------|--------|
          EOF
          
          # Add build information for each artifact / ä¸ºæ¯ä¸ªäº§ç‰©æ·»åŠ æž„å»ºä¿¡æ¯
          for compressed_dir in compressed/*/; do
            if [ -d "$compressed_dir" ]; then
              artifact_name=$(basename "$compressed_dir")
              
              # Look for JSON file / æŸ¥æ‰¾ JSON æ–‡ä»¶
              json_file=$(find "$compressed_dir" -name "*.json" | head -1)
              if [ ! -f "$json_file" ]; then
                json_file=$(find output/ -name "*${artifact_name}*.json" | head -1)
              fi
              
              if [ -f "$json_file" ]; then
                # Extract ISO information from JSON / ä»Ž JSON ä¸­æå– ISO ä¿¡æ¯
                iso_info=$(cat "$json_file")
                iso_name=$(echo "$iso_info" | jq -r '.name')
                iso_build=$(echo "$iso_info" | jq -r '.build')
                iso_title=$(echo "$iso_info" | jq -r '.titleSafe // .title')
                iso_checksum=$(echo "$iso_info" | jq -r '.checksum')
                
                # Determine file type / ç¡®å®šæ–‡ä»¶ç±»åž‹
                split_files=$(ls compressed/${artifact_name}/${artifact_name}.7z.* 2>/dev/null | wc -l)
                single_archive=$(ls compressed/${artifact_name}/${artifact_name}.7z 2>/dev/null | wc -l)
                raw_files=$(find compressed/${artifact_name}/ -name "*.iso" -o -name "*.json" -o -name "*.txt" | wc -l)
                
                if [ $split_files -gt 0 ]; then
                  file_type="åˆ†å·åŽ‹ç¼© (${split_files} ä¸ªæ–‡ä»¶)"
                elif [ $single_archive -gt 0 ]; then
                  file_type="å•ä¸ªåŽ‹ç¼©åŒ…"
                elif [ $raw_files -gt 0 ]; then
                  file_type="åŽŸå§‹æ–‡ä»¶"
                else
                  file_type="å¤„ç†å¼‚å¸¸"
                fi
                
                echo "| **$iso_name** | $iso_build | $file_type | \`${iso_checksum:0:8}...\` |" >> release-notes.md
              fi
            fi
          done
          
          cat >>release-notes.md <<EOF
          
          ## ðŸ“¥ ä¸‹è½½æ–¹å¼
          
          ### æ–¹å¼ä¸€ï¼šRelease ä¸‹è½½ï¼ˆæŽ¨èï¼‰
          
          1. **ç‚¹å‡»ä¸‹æ–¹ Assets åŒºåŸŸ**å±•å¼€æ–‡ä»¶åˆ—è¡¨
          2. **ä¸‹è½½å¯¹åº”çš„æ–‡ä»¶**ï¼š
             - åˆ†å·åŽ‹ç¼©ï¼šä¸‹è½½æ‰€æœ‰ `.7z.001`, `.7z.002` ç­‰æ–‡ä»¶
             - å•ä¸ªåŽ‹ç¼©ï¼šä¸‹è½½ `.7z` æ–‡ä»¶
             - åŽŸå§‹æ–‡ä»¶ï¼šç›´æŽ¥ä¸‹è½½ `.iso` æ–‡ä»¶
          3. **è§£åŽ‹ä½¿ç”¨**ï¼šåˆ†å·å’ŒåŽ‹ç¼©æ–‡ä»¶éœ€ç”¨ [7-Zip](https://www.7-zip.org/) è§£åŽ‹
          
          ### æ–¹å¼äºŒï¼šArtifacts ä¸‹è½½
          
          1. **è®¿é—®æž„å»ºé¡µé¢**ï¼š[GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          2. **æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨** Artifacts åŒºåŸŸ
          3. **ç‚¹å‡»å¯¹åº”çš„æž„å»ºåç§°**ä¸‹è½½å®Œæ•´åŒ…
          4. **è§£åŽ‹ä¸¤æ¬¡**ï¼šå…ˆè§£åŽ‹ä¸‹è½½çš„ zipï¼Œå†è§£åŽ‹å†…éƒ¨çš„ 7z æ–‡ä»¶
          
          ## âš ï¸ é‡è¦æé†’
          
          - **åˆ†å·æ–‡ä»¶**ï¼šå¿…é¡»ä¸‹è½½åŒä¸€ ISO çš„æ‰€æœ‰åˆ†å·æ‰èƒ½æ­£ç¡®è§£åŽ‹
          - **æ–‡ä»¶å¤§å°**ï¼šæ¯ä¸ª ISO çº¦ 4-5GBï¼Œè¯·ç¡®ä¿è¶³å¤Ÿå­˜å‚¨ç©ºé—´
          - **æ ¡éªŒæ–‡ä»¶**ï¼šå»ºè®®ä¸‹è½½ `.sha256.txt` éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
          - **è§£åŽ‹å·¥å…·**ï¼šæŽ¨èä½¿ç”¨ [7-Zip](https://www.7-zip.org/) å¤„ç†åŽ‹ç¼©æ–‡ä»¶
          
          ---
          
          ðŸ’¡ **é¦–æ¬¡ä½¿ç”¨å»ºè®®é€‰æ‹©æ–¹å¼ä¸€ï¼ˆRelease ä¸‹è½½ï¼‰**ï¼Œæ“ä½œæ›´ç®€å•ç›´æŽ¥ã€‚
          EOF
      # Create GitHub release with compressed files / ä½¿ç”¨åŽ‹ç¼©æ–‡ä»¶åˆ›å»º GitHub å‘å¸ƒ
      - name: Release
        uses: ncipollo/release-action@v1
        with:
          bodyFile: release-notes.md                                    # Use generated release notes / ä½¿ç”¨ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜Ž
          artifacts: compressed/*/*                                     # Upload all compressed files / ä¸Šä¼ æ‰€æœ‰åŽ‹ç¼©æ–‡ä»¶
          token: ${{ secrets.GITHUB_TOKEN }}                           # GitHub token for authentication / ç”¨äºŽèº«ä»½éªŒè¯çš„ GitHub ä»¤ç‰Œ
          generateReleaseNotes: false                                   # Don't auto-generate notes / ä¸è‡ªåŠ¨ç”Ÿæˆè¯´æ˜Ž
          makeLatest: legacy                                            # Mark as latest release / æ ‡è®°ä¸ºæœ€æ–°å‘å¸ƒ
          omitBody: false                                               # Include release body / åŒ…å«å‘å¸ƒæ­£æ–‡
          omitBodyDuringUpdate: false                                   # Include body during updates / æ›´æ–°æ—¶åŒ…å«æ­£æ–‡
          omitDraftDuringUpdate: false                                  # Include draft during updates / æ›´æ–°æ—¶åŒ…å«è‰ç¨¿
          omitName: false                                               # Include release name / åŒ…å«å‘å¸ƒåç§°
          omitNameDuringUpdate: false                                   # Include name during updates / æ›´æ–°æ—¶åŒ…å«åç§°
          omitPrereleaseDuringUpdate: false                             # Include prerelease during updates / æ›´æ–°æ—¶åŒ…å«é¢„å‘å¸ƒ
          removeArtifacts: false                                        # Don't remove existing artifacts / ä¸åˆ é™¤çŽ°æœ‰äº§ç‰©
          replacesArtifacts: true                                       # Replace existing artifacts / æ›¿æ¢çŽ°æœ‰äº§ç‰©
          skipIfReleaseExists: false                                    # Don't skip if release exists / å¦‚æžœå‘å¸ƒå­˜åœ¨ä¸è·³è¿‡
          updateOnlyUnreleased: false                                   # Update all releases / æ›´æ–°æ‰€æœ‰å‘å¸ƒ
          tag: "build-${{ github.run_number }}-${{ github.run_attempt }}"  # Release tag format / å‘å¸ƒæ ‡ç­¾æ ¼å¼
