# Auto scrape UUP Dump data using Playwright
# ä½¿ç”¨ Playwright è‡ªåŠ¨æŠ“å– UUP Dump æ•°æ®
name: scrape

on:
  workflow_dispatch: # Manual trigger / æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *' # Run at 02:00 UTC daily / æ¯æ—¥ UTC 02:00 è¿è¡Œ

jobs:
  # Scrape UUP Dump data / æŠ“å– UUP Dump æ•°æ®
  scrape:
    runs-on: ubuntu-latest
    steps:
      # Checkout code / æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Install pnpm / å®‰è£… pnpm
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # Setup Node.js / è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          cache-dependency-path: 'playwright/pnpm-lock.yaml'

      # Install Playwright dependencies / å®‰è£… Playwright ä¾èµ–
      - name: Install Playwright dependencies
        run: |
          cd playwright
          pnpm install
          npx playwright install chromium

      # Run Playwright scraping / è¿è¡Œ Playwright æŠ“å–
      - name: Run Playwright scraping
        run: |
          cd playwright
          pnpm run scrape

      # Check for changes / æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      # Commit and push changes / æäº¤å¹¶æŽ¨é€å˜æ›´
      - name: Commit and push changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add playwright/output/
          git commit -m "ðŸ¤– Auto update UUP Dump data - $(date -u +"%Y-%m-%d %H:%M UTC")"
          git push

      # Upload artifacts / ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uupdump-data-${{ github.run_number }}
          path: |
            playwright/output/*.json
          retention-days: 7 # Keep artifacts for 7 days / æž„å»ºäº§ç‰©ä¿ç•™7å¤©

      # Create summary / åˆ›å»ºæ‘˜è¦
      - name: Create summary
        run: |
          echo "## ðŸ“Š UUP Dump æ•°æ®æŠ“å–å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æŠ“å–æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**å·¥ä½œæµè¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "playwright/output/uupdump-data.json" ]]; then
            echo "### ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "- \`playwright/output/uupdump-data.json\` - ä¸»æ•°æ®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "- \`playwright/output/uupdump-types-summary.json\` - åˆ†ç±»æ±‡æ€»æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show file sizes / æ˜¾ç¤ºæ–‡ä»¶å¤§å°
            echo "### ðŸ“ æ–‡ä»¶å¤§å°" >> $GITHUB_STEP_SUMMARY
            ls -lh playwright/output/*.json | awk '{print "- " $9 ": " $5}' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show summary stats if types summary exists / å¦‚æžœåˆ†ç±»æ±‡æ€»å­˜åœ¨åˆ™æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            if [[ -f "playwright/output/uupdump-types-summary.json" ]]; then
              echo "### ðŸ“ˆ æ•°æ®ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
              node -e "
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('playwright/output/uupdump-types-summary.json', 'utf8'));
                console.log('| ç‰ˆæœ¬ç±»åž‹ | æ•°é‡ |');
                console.log('|---------|------|');
                Object.entries(data.countsByType).forEach(([type, count]) => {
                  console.log(\`| \${type} | \${count} |\`);
                });
              " >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi