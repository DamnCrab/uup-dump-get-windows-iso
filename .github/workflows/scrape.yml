# Auto scrape UUP Dump data using Playwright
# ä½¿ç”¨ Playwright è‡ªåŠ¨æŠ“å– UUP Dump æ•°æ®
name: scrape

on:
  workflow_dispatch: # Manual trigger / æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *' # Run at 02:00 UTC daily / æ¯æ—¥ UTC 02:00 è¿è¡Œ

jobs:
  # Scrape UUP Dump data / æŠ“å– UUP Dump æ•°æ®
  scrape:
    runs-on: ubuntu-latest
    steps:
      # Checkout code / æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Install pnpm / å®‰è£… pnpm
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # Setup Node.js / è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          cache-dependency-path: 'playwright/pnpm-lock.yaml'

      # Install Playwright dependencies / å®‰è£… Playwright ä¾èµ–
      - name: Install Playwright dependencies
        run: |
          cd playwright
          pnpm install
          npx playwright install chromium

      # Run Playwright scraping / è¿è¡Œ Playwright æŠ“å–
      - name: Run Playwright scraping
        run: |
          cd playwright
          pnpm run scrape
          pnpm run analyze

      # Check for changes / æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      # Deploy to data branch / å‘å¸ƒåˆ° data åˆ†æ”¯
      - name: Deploy to data branch
        if: steps.changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Save data to temp dir / ä¿å­˜æ•°æ®åˆ°ä¸´æ—¶ç›®å½•
          mkdir -p ../uupdump_data_temp
          cp playwright/output/*.json ../uupdump_data_temp/
          
          # Switch to orphan branch / åˆ‡æ¢åˆ°å­¤å„¿åˆ†æ”¯
          git checkout --orphan data
          git reset --hard
          git clean -fdx
          
          # Restore data to root / å°†æ•°æ®æ¢å¤åˆ°æ ¹ç›®å½•
          cp ../uupdump_data_temp/*.json .
          
          # Commit and push / æäº¤å¹¶æŽ¨é€
          git add *.json
          git commit -m "ðŸ¤– Auto update UUP Dump data - $(date -u +"%Y-%m-%d %H:%M UTC")"
          git push -f origin data

      # Upload artifacts / ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uupdump-data-${{ github.run_number }}
          path: |
            playwright/output/*.json
          retention-days: 7 # Keep artifacts for 7 days / æž„å»ºäº§ç‰©ä¿ç•™7å¤©

      # Create summary / åˆ›å»ºæ‘˜è¦
      - name: Create summary
        run: |
          echo "## ðŸ“Š UUP Dump Data Update" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Run Details**: [View Log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "playwright/output/uupdump-data.json" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
            ls -lh playwright/output/*.json | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No data files generated." >> $GITHUB_STEP_SUMMARY
          fi